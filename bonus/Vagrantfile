MASTER_IP = "192.168.56.113"

Vagrant.configure(2) do |config|
    config.vm.box = "debian/bookworm64"
    config.vm.synced_folder ".", "/vagrant", type: "nfs", disabled: true

    config.vm.provider "libvirt" do |v|
        v.memory = 12288
        v.cpus = 4
        v.driver = "kvm"
    end

    config.vm.define "arbutnarS" do |control|
        control.vm.hostname = "arbutnarS"
        control.vm.network "private_network", ip: MASTER_IP

        control.vm.provision "shell", path: "../p3/scripts/init.sh"
        control.vm.provision "shell", inline: <<-SHELL

            # Install Helm
            curl -fsSL -o /tmp/helm.tar.gz "https://get.helm.sh/helm-v4.0.0-linux-amd64.tar.gz"
            tar -xzf /tmp/helm.tar.gz -C /tmp
            install -o root -g root -m 0755 /tmp/linux-amd64/helm /usr/local/bin/helm
            rm -rf /tmp/helm.tar.gz /tmp/linux-amd64

            # Deploy GitLab via Helm
            helm repo add gitlab http://charts.gitlab.io/
            helm repo update
            kubectl create namespace gitlab
            helm upgrade --install gitlab gitlab/gitlab -n gitlab \
                --version 9.6.1 \
                --set installCertmanager=false \
                --set global.ingress.configureCertmanager=false \
                --set gitlab-runner.install=false \
                --set global.kas.enabled=false \
                --set prometheus.install=false \
                --set postgresql.metrics.enabled=false \
                --set redis.metrics.enabled=false \
                --set gitlab.gitlab-exporter.enabled=false \
                --set global.grafana.enabled=false \
                --set gitlab.gitlab-pages.enabled=false \
                --set gitlab.webservice.minReplicas=1 \
                --set gitlab.webservice.maxReplicas=1 \
                --set gitlab.sidekiq.minReplicas=1 \
                --set gitlab.sidekiq.maxReplicas=1 \
                --set gitlab.gitlab-shell.minReplicas=1 \
                --set gitlab.gitlab-shell.maxReplicas=1 \
                --set nginx-ingress.controller.replicaCount=1 \
                --set nginx-ingress.controller.service.type=NodePort \
                --wait --timeout 1200s

            curl -sSL -o /usr/local/bin/argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
            chmod +x /usr/local/bin/argocd
        SHELL
        control.vm.provision "shell", run: "always", path: "../p3/scripts/forward_argocd.sh", args: ["#{MASTER_IP}"]
        control.vm.provision "shell", run: "always", path: "scripts/forward_gitlab.sh"
    end

end
